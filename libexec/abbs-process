#! /bin/bash
. $ABBS/env/base.sh
abbscheckspec $1

abrequire pm

ABDEP="`abbscalcdep $1`"
pm_checkdep $ABDEP || abdie "Dependencies are not satisfied for $1"

. $ABBS/repo/$1/spec

SPECSEC=`dirname $1`
SPECNAM=`basename $1`

BUILDENV="`abbsallocenv $SPECSEC-$SPECNAM`"

echo "Preparing" >> $BUILDENV/.status

if [ "x$SRCTBL" != "x" ]
then
	TBLNM="`basename $SRCTBL`"
	TBLNM="`echo $TBLNM | cut -d \? -f 1`"
	[ ! -e $ABBSTBLPOS/$TBLNM ] && wget $SRCTBL -O $ABBSTBLPOS/$TBLNM
	# tar xvf $ABBSTBLPOS/$TBLNM -C $BUILDENV
    # Adapting abbsuniformextract here.
    pushd $BUILDENV
    $ABBS/libexec/abbsuniformextract $ABBSTBLPOS/$TBLNM
    popd
elif bool $DUMMYSRC
then
	mkdir $BUILDENV/dummy
fi

if [ "x$GITSRC" != "x" ]
then
	GITNM="`basename $GITSRC`"
	GITNM="`echo $GITNM | cut -d \? -f 1`"
    if [ "x$GITBRCH" != "x" ]
    then
        [ ! -e $ABBSTBLPOS/$GITNM ] && git clone -b $GITBRCH $GITSRC -C $ABBSTBLPOS $GITNM
    else
    	[ ! -e $ABBSTBLPOS/$GITNM ] && git clone $GITSRC -C $ABBSTBLPOS $GITNM
    fi
    if [ "x$GITCO" != "x" ]
    then
        pushd $ABBSTBLPOS/$GITNM
        git checkout tags/$GITCO
        popd
    else
        true
    fi
elif bool $DUMMYSRC
then
	mkdir $BUILDENV/dummy
fi

if [ "x$SVNSRC" != "x" ]
then
	SVNNM="`basename $SVNSRC`"
	SVNNM="`echo $SVNNM | cut -d \? -f 1`"
   	[ ! -e $ABBSTBLPOS/$SVNNM ] && pushd $ABBSTBLPOS; \
                                                                      svn co --quiet $SVNSRC; \
                                                                      popd
elif bool $DUMMYSRC
then
	mkdir $BUILDENV/dummy
fi

if [ "x$HGSRC" != "x" ]
then
	HGNM="`basename $HGSRC`"
	HGNM="`echo $HGNM | cut -d \? -f 1`"
   	[ ! -e $ABBSTBLPOS/$HGNM ] && pushd $ABBSTBLPOS; \
                                                                    hg clone $HGSRC; \
                                                                    popd
elif bool $DUMMYSRC
then
	mkdir $BUILDENV/dummy
fi

if [ "x$BZRSRC" != "x" ]
then
	BZRNM="`basename $BZRSRC`"
	BZRNM="`echo $BZRNM | cut -d \? -f 1`"
   	[ ! -e $ABBSTBLPOS/$BZRNM ] && pushd $ABBSTBLPOS; \
                                                                      bzr branch $BZRSRC; \
                                                                      popd
elif bool $DUMMYSRC
then
	mkdir $BUILDENV/dummy
fi

if [ "x$SUBDIR" = "x" ]
then
	[ ! -d $BUILDENV/`ls $BUILDENV` ] && 
	abdie "Cannot determine the packing subdir."
	SUBDIR=`ls $BUILDENV`
fi

echo "Building" >> $BUILDENV/.status

for i in $ABBS/repo/$1/*
do
	[ ! -d $i ] && continue
	rm -rf $BUILDENV/$SUBDIR/autobuild
	rm -rf $BUILDENV/$SUBDIR/abdist
	cp -r $i $BUILDENV/$SUBDIR/autobuild
	if [ "x$VER" != "x" ]
	then
		echo "PKGVER=$VER" >> $BUILDENV/$SUBDIR/autobuild/defines
	fi
	pushd $BUILDENV/$SUBDIR
	autobuild || abdie "Autobuild returns non-zero value"
	popd
done

echo "Success" > $BUILDENV/.status
